<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Carnet Gastro Collaboratif</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold fs-3" href="#">
                <i class="bi bi-cup-hot text-primary"></i>
                Mon Carnet Gastro
                <span class="badge bg-secondary fs-6" id="syncStatus">‚öôÔ∏è Configuration...</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="githubDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-github"></i> GitHub
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="manualSync()">
                                <i class="bi bi-arrow-clockwise"></i> Synchroniser maintenant
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="showGitHubConfig()">
                                <i class="bi bi-gear"></i> Configuration GitHub
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="exportData()">
                            <i class="bi bi-download"></i> Export local
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 80px;">
        <div class="main-container">
            <!-- Hero Section -->
            <div class="hero-section">
                <h1 class="display-4 fw-bold mb-3">Mon Carnet Gastro Collaboratif</h1>
                <p class="fs-5 mb-4">D√©couvrez, notez et partagez vos meilleures adresses culinaires avec vos amis</p>
                <div class="d-flex justify-content-center gap-3 mb-4">
                    <button id="findNearbyHero" class="btn btn-light btn-lg">
                        <i class="bi bi-geo-alt-fill"></i> Restaurants pr√®s de moi
                    </button>
                    <button class="btn btn-outline-light btn-lg" onclick="manualSync()">
                        <i class="bi bi-cloud-arrow-down"></i> Synchroniser
                    </button>
                </div>
                
                <!-- Indicateur de collaboration -->
                <div class="alert alert-info d-inline-block">
                    <i class="bi bi-people-fill"></i>
                    <strong>Carnet collaboratif :</strong> Vos amis peuvent aussi ajouter des restaurants !
                    <br><small>Synchronisation automatique avec GitHub</small>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="container py-5">
                <div class="row g-4">
                    <div class="col-md-3">
                        <div class="card stats-card text-center h-100">
                            <div class="card-body">
                                <i class="bi bi-star-fill fs-1 mb-2"></i>
                                <h2 class="card-title" id="tested-count">0</h2>
                                <p class="card-text">Restaurants test√©s</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center h-100">
                            <div class="card-body">
                                <i class="bi bi-heart-fill fs-1 mb-2"></i>
                                <h2 class="card-title" id="wishlist-count">0</h2>
                                <p class="card-text">Dans ma wishlist</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center h-100">
                            <div class="card-body">
                                <i class="bi bi-trophy-fill fs-1 mb-2"></i>
                                <h2 class="card-title" id="avg-rating">--</h2>
                                <p class="card-text">Note moyenne</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card stats-card text-center h-100">
                            <div class="card-body">
                                <i class="bi bi-globe fs-1 mb-2"></i>
                                <h2 class="card-title" id="countries-count">--</h2>
                                <p class="card-text">Pays explor√©s</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="container">
                <ul class="nav nav-pills nav-fill mb-4" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tested-tab" data-bs-toggle="pill" data-bs-target="#tested" type="button">
                            <i class="bi bi-star-fill"></i> Restaurants Test√©s
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="wishlist-tab" data-bs-toggle="pill" data-bs-target="#wishlist" type="button">
                            <i class="bi bi-heart-fill"></i> Ma Wishlist
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="map-tab" data-bs-toggle="pill" data-bs-target="#map-section" type="button">
                            <i class="bi bi-geo-alt-fill"></i> Carte Interactive
                        </button>
                    </li>
                </ul>
            </div>

            <!-- Tab Content -->
            <div class="tab-content p-4" id="mainTabContent">
                <!-- Tested Restaurants -->
                <div class="tab-pane fade show active" id="tested" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>üåü Mes D√©couvertes</h3>
                        <button class="btn btn-primary" onclick="openAddModal('tested')">
                            <i class="bi bi-plus-lg"></i> Ajouter un restaurant
                        </button>
                    </div>
                    <div class="row" id="tested-grid">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>

                <!-- Wishlist -->
                <div class="tab-pane fade" id="wishlist" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3>‚ù§Ô∏è Ma Liste d'Envies</h3>
                        <button class="btn btn-success" onclick="openAddModal('wishlist')">
                            <i class="bi bi-plus-lg"></i> Ajouter une envie
                        </button>
                    </div>
                    <div class="row" id="wishlist-grid">
                        <!-- Generated by JavaScript -->
                    </div>
                </div>

                <!-- Map -->
                <div class="tab-pane fade" id="map-section" role="tabpanel">
                    <h3 class="mb-4">üó∫Ô∏è Carte Interactive</h3>
                    <div id="map"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Add Button -->
    <button id="addFloatingBtn" class="btn btn-primary add-button" title="Ajouter">
        <i class="bi bi-plus-lg"></i>
    </button>

    <!-- Modal Add/Edit Restaurant -->
    <div class="modal fade" id="restaurantModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Ajouter un restaurant</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="restaurantForm">
                        <input type="hidden" id="editId">
                        <input type="hidden" id="modalType">
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Nom du restaurant *</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Type de cuisine *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="cuisineInput" placeholder="Tapez ou choisissez" required>
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-chevron-down"></i>
                                    </button>
                                    <ul class="dropdown-menu" id="cuisineDropdown">
                                        <!-- Dynamically populated -->
                                    </ul>
                                </div>
                                <small class="form-text text-muted">Vous pouvez taper un nouveau type de cuisine</small>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Localisation *</label>
                                <input type="text" class="form-control" id="location" placeholder="ex: 6√®me arrondissement, Tokyo, New York" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Prix</label>
                                <select class="form-control" id="priceRange">
                                    <option value="‚Ç¨">‚Ç¨ (moins de 20‚Ç¨)</option>
                                    <option value="‚Ç¨‚Ç¨" selected>‚Ç¨‚Ç¨ (20-40‚Ç¨)</option>
                                    <option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨ (40-80‚Ç¨)</option>
                                    <option value="‚Ç¨‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ (plus de 80‚Ç¨)</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Adresse compl√®te</label>
                            <input type="text" class="form-control" id="address" placeholder="Pour g√©olocalisation automatique">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Photo (URL)</label>
                            <input type="url" class="form-control" id="photo" placeholder="https://...">
                        </div>

                        <!-- Ratings section (only for tested restaurants) -->
                        <div id="ratingsSection" style="display: none;">
                            <h6 class="mb-3">üìä Notations</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">üçΩÔ∏è Plats (coefficient x2)</label>
                                    <div class="star-rating" data-rating="plats">
                                        <span class="star" data-value="1">‚òÖ</span>
                                        <span class="star" data-value="2">‚òÖ</span>
                                        <span class="star" data-value="3">‚òÖ</span>
                                        <span class="star" data-value="4">‚òÖ</span>
                                        <span class="star" data-value="5">‚òÖ</span>
                                    </div>
                                    <input type="hidden" id="platsRating" value="5">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">üç∑ Vins (coefficient x1.5)</label>
                                    <div class="star-rating" data-rating="vins">
                                        <span class="star" data-value="1">‚òÖ</span>
                                        <span class="star" data-value="2">‚òÖ</span>
                                        <span class="star" data-value="3">‚òÖ</span>
                                        <span class="star" data-value="4">‚òÖ</span>
                                        <span class="star" data-value="5">‚òÖ</span>
                                    </div>
                                    <input type="hidden" id="vinsRating" value="5">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">üòä Accueil (coefficient x1.5)</label>
                                    <div class="star-rating" data-rating="accueil">
                                        <span class="star" data-value="1">‚òÖ</span>
                                        <span class="star" data-value="2">‚òÖ</span>
                                        <span class="star" data-value="3">‚òÖ</span>
                                        <span class="star" data-value="4">‚òÖ</span>
                                        <span class="star" data-value="5">‚òÖ</span>
                                    </div>
                                    <input type="hidden" id="accueilRating" value="5">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">üèõÔ∏è Lieu (coefficient x1)</label>
                                    <div class="star-rating" data-rating="lieu">
                                        <span class="star" data-value="1">‚òÖ</span>
                                        <span class="star" data-value="2">‚òÖ</span>
                                        <span class="star" data-value="3">‚òÖ</span>
                                        <span class="star" data-value="4">‚òÖ</span>
                                        <span class="star" data-value="5">‚òÖ</span>
                                    </div>
                                    <input type="hidden" id="lieuRating" value="5">
                                </div>
                            </div>
                        </div>

                        <!-- Wishlist specific fields -->
                        <div id="wishlistSection" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">üí° Pourquoi voulez-vous tester ce restaurant ?</label>
                                <textarea class="form-control" id="reason" rows="2" placeholder="ex: Recommand√© par un ami..."></textarea>
                            </div>
                        </div>

                        <!-- Comment section -->
                        <div class="mb-3">
                            <label class="form-label">üí¨ Commentaire</label>
                            <textarea class="form-control" id="comment" rows="3" placeholder="Vos impressions, recommandations..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="saveRestaurant()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Transfer to Tested -->
    <div class="modal fade" id="transferModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üåü Transf√©rer vers "Test√©s"</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Ajoutez vos notes pour <strong id="transferRestaurantName"></strong> :</p>
                    <form id="transferForm">
                        <input type="hidden" id="transferId">
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">üçΩÔ∏è Plats (x2)</label>
                                <div class="star-rating" data-rating="transferPlats">
                                    <span class="star" data-value="1">‚òÖ</span>
                                    <span class="star" data-value="2">‚òÖ</span>
                                    <span class="star" data-value="3">‚òÖ</span>
                                    <span class="star" data-value="4">‚òÖ</span>
                                    <span class="star" data-value="5">‚òÖ</span>
                                </div>
                                <input type="hidden" id="transferPlatsRating" value="5">
                            </div>
                            <div class="col-6">
                                <label class="form-label">üç∑ Vins (x1.5)</label>
                                <div class="star-rating" data-rating="transferVins">
                                    <span class="star" data-value="1">‚òÖ</span>
                                    <span class="star" data-value="2">‚òÖ</span>
                                    <span class="star" data-value="3">‚òÖ</span>
                                    <span class="star" data-value="4">‚òÖ</span>
                                    <span class="star" data-value="5">‚òÖ</span>
                                </div>
                                <input type="hidden" id="transferVinsRating" value="5">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">üòä Accueil (x1.5)</label>
                                <div class="star-rating" data-rating="transferAccueil">
                                    <span class="star" data-value="1">‚òÖ</span>
                                    <span class="star" data-value="2">‚òÖ</span>
                                    <span class="star" data-value="3">‚òÖ</span>
                                    <span class="star" data-value="4">‚òÖ</span>
                                    <span class="star" data-value="5">‚òÖ</span>
                                </div>
                                <input type="hidden" id="transferAccueilRating" value="5">
                            </div>
                            <div class="col-6">
                                <label class="form-label">üèõÔ∏è Lieu (x1)</label>
                                <div class="star-rating" data-rating="transferLieu">
                                    <span class="star" data-value="1">‚òÖ</span>
                                    <span class="star" data-value="2">‚òÖ</span>
                                    <span class="star" data-value="3">‚òÖ</span>
                                    <span class="star" data-value="4">‚òÖ</span>
                                    <span class="star" data-value="5">‚òÖ</span>
                                </div>
                                <input type="hidden" id="transferLieuRating" value="5">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">üí¨ Votre avis apr√®s visite</label>
                            <textarea class="form-control" id="transferComment" rows="3" placeholder="Comment s'est pass√©e votre exp√©rience ?"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success" onclick="transferToTested()">
                        <i class="bi bi-arrow-right"></i> Transf√©rer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="script.js"></script>

    <script>
    // Fonction helper pour afficher la configuration GitHub
    function showGitHubConfig() {
        // Recr√©er et afficher le modal de configuration
        const existingModal = document.getElementById('githubSetupModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modal = restaurantManager.github.createSetupModal();
        document.body.appendChild(modal);
        
        // Pr√©remplir avec les valeurs existantes
        const owner = localStorage.getItem('githubOwner');
        const token = localStorage.getItem('githubToken');
        
        if (owner) modal.querySelector('#setupOwner').value = owner;
        if (token) modal.querySelector('#setupToken').value = token;
        
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        const saveBtn = modal.querySelector('#saveGitHubSetup');
        saveBtn.addEventListener('click', async () => {
            const newToken = modal.querySelector('#setupToken').value;
            const newOwner = modal.querySelector('#setupOwner').value;
            
            if (newToken && newOwner) {
                restaurantManager.github.token = newToken;
                restaurantManager.github.config.owner = newOwner;
                
                localStorage.setItem('githubToken', newToken);
                localStorage.setItem('githubOwner', newOwner);
                
                bsModal.hide();
                modal.remove();
                
                try {
                    await restaurantManager.github.setup();
                    await restaurantManager.loadData();
                    restaurantManager.renderSections();
                    restaurantManager.showToast('‚úÖ Configuration GitHub mise √† jour !', 'success');
                    restaurantManager.updateSyncStatus('‚úÖ Synchronis√©');
                } catch (error) {
                    restaurantManager.showToast('‚ùå Erreur de configuration : ' + error.message, 'danger');
                    restaurantManager.updateSyncStatus('‚ùå Erreur de config');
                }
            }
        });
    }
    </script>
</body>
</html>
